<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory | DOUBLE ACTION</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
    header { background-color: #000; padding: 10px 0; }
    .navbar-brand img { height: 50px; }
    .navbar-nav .nav-link { color: #fff !important; margin-left: 15px; }
    .container { margin-top: 30px; }
    .table-warning { --bs-table-bg: #fff3cd; } /* For low stock items */
    .timestamp { font-size: 0.85rem; color: #6c757d; }
  </style>
</head>
<body>

<header>
  <nav class="navbar navbar-expand-lg container">
    <a class="navbar-brand" href="index.html">
      <img src="A_logo_for_\"DOUBLE_ACTION\"_is_presented_on_a_white.png" alt="DOUBLE ACTION logo">
    </a>
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link active" href="inventory.html">Inventory</a></li>
        <li class="nav-item"><a class="nav-link" href="orders.html">Orders</a></li>
        <li class="nav-item"><a class="nav-link" href="analytics.html">Analytics</a></li>
        <li class="nav-item"><a class="nav-link" href="login.html">Logout</a></li>
      </ul>
    </div>
  </nav>
</header>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Inventory Management</h2>
    <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#itemModal" onclick="openAddModal()"><i class="bi bi-plus-circle"></i> Add Item</button>
  </div>
  
  <table class="table table-bordered table-hover">
    <thead class="table-dark">
      <tr>
        <th>SKU</th>
        <th>Name</th>
        <th>Category</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Min Qty</th>
        <th>Date Added</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="inventoryTable"></tbody>
  </table>
</div>

<!-- Modal for Add/Edit Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemModalLabel">Add/Edit Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <input type="hidden" id="editId">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="itemName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" id="itemCategory" required>
              <option value="">Select Category</option>
              <option value="Fabrics">Fabrics</option>
              <option value="Pants">Pants</option>
              <option value="Vests">Vests</option>
              <option value="Jackets">Jackets</option>
              <option value="Shirts">Shirts</option>
              <option value="Ties">Ties</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="number" class="form-control" id="itemQuantity" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Price</label>
            <input type="number" step="0.01" class="form-control" id="itemPrice" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Min Quantity</label>
            <input type="number" class="form-control" id="itemMinQuantity" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveItem()">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "http://127.0.0.1:5000/products";

  function openAddModal() {
    document.getElementById("itemForm").reset();
    document.getElementById("editId").value = "";
    document.getElementById("itemModalLabel").textContent = "Add Item";
  }

  function openEditModal(item) {
    document.getElementById("editId").value = item.product_id;
    document.getElementById("itemName").value = item.name;
    document.getElementById("itemCategory").value = item.category;
    document.getElementById("itemQuantity").value = item.quantity;
    document.getElementById("itemPrice").value = item.price;
    document.getElementById("itemMinQuantity").value = item.min_quantity;
    document.getElementById("itemModalLabel").textContent = "Edit Item";
    const modal = new bootstrap.Modal(document.getElementById("itemModal"));
    modal.show();
  }

  async function saveItem() {
    const item = {
      name: document.getElementById("itemName").value,
      category: document.getElementById("itemCategory").value,
      quantity: parseInt(document.getElementById("itemQuantity").value),
      price: parseFloat(document.getElementById("itemPrice").value),
      min_quantity: parseInt(document.getElementById("itemMinQuantity").value),
    };
    const id = document.getElementById("editId").value;
    const method = id ? "PUT" : "POST";
    const url = id ? `${API_URL}/${id}` : API_URL;

    const res = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(item),
    });

    if (res.ok) {
      renderTable();
      bootstrap.Modal.getInstance(document.getElementById("itemModal")).hide();
    } else {
      alert("Error saving item.");
    }
  }

  async function deleteItem(id) {
    if (!confirm("Are you sure you want to delete this item?")) return;
    const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
    if (res.ok) renderTable();
  }

  async function renderTable() {
    try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Network response was not ok");
        const inventory = await res.json();
        const table = document.getElementById("inventoryTable");
        table.innerHTML = "";

        inventory.forEach(item => {
            const row = document.createElement("tr");
            if (item.quantity <= item.min_quantity) {
                row.classList.add("table-warning");
            }
            
            row.innerHTML = `
                <td>${item.sku || 'N/A'}</td>
                <td>${item.name}</td>
                <td>${item.category}</td>
                <td>${item.quantity}</td>
                <td>$${item.price ? item.price.toFixed(2) : '0.00'}</td>
                <td>${item.min_quantity}</td>
                <td class="timestamp">${item.creation_timestamp ? new Date(item.creation_timestamp).toLocaleString('he-IL') : 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick='openEditModal(${JSON.stringify(item)})'><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.product_id})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            table.appendChild(row);
        });
    } catch(error) {
        console.error("Failed to render table:", error);
        document.getElementById("inventoryTable").innerHTML = `<tr><td colspan="8" class="text-center text-danger">Could not load inventory data. Please check if the server is running.</td></tr>`;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const role = sessionStorage.getItem("role") || "guest";
    if (role !== "admin") {
      document.body.innerHTML = '<div class="alert alert-danger text-center m-5">Access Denied. Please <a href="login.html">login</a> as an administrator.</div>';
      return;
    }
    renderTable();
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orders | DOUBLE ACTION</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
    header { background-color: #000; padding: 10px 0; }
    .navbar-brand img { height: 50px; }
    .navbar-nav .nav-link { color: #fff !important; margin-left: 15px; }
    .container { margin-top: 30px; }
    .status-select { min-width: 150px; }
    .timestamp { font-size: 0.8rem; color: #6c757d; }
  </style>
</head>
<body>

<header>
  <nav class="navbar navbar-expand-lg container">
    <a class="navbar-brand" href="index.html">
      <img src="A_logo_for_\"DOUBLE_ACTION\"_is_presented_on_a_white.png" alt="DOUBLE ACTION logo" />
    </a>
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="inventory.html">Inventory</a></li>
        <li class="nav-item"><a class="nav-link active" href="orders.html">Orders</a></li>
        <li class="nav-item"><a class="nav-link" href="analytics.html">Analytics</a></li>
        <li class="nav-item"><a class="nav-link" href="login.html">Logout</a></li>
      </ul>
    </div>
  </nav>
</header>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Orders Management</h2>
    <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#orderModal"><i class="bi bi-plus-circle"></i> Add Order</button>
  </div>
  
  <div class="card card-body bg-light mb-3">
    <div class="row g-3 align-items-center">
      <div class="col-md-5">
        <input type="text" class="form-control" id="searchName" placeholder="Search by Customer Name...">
      </div>
      <div class="col-md-5">
        <select id="searchStatus" class="form-select">
          <option value="">All Statuses</option>
          <option value="Order Received">Order Received</option>
          <option value="Pending">Pending</option>
          <option value="Shipped">Shipped</option>
          <option value="Delivered">Delivered</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
      <div class="col-md-2 d-grid">
          <button class="btn btn-primary" id="searchBtn"><i class="bi bi-search"></i> Search</button>
      </div>
    </div>
  </div>
  
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Timestamps</th> <!-- UPDATED: Combined timestamp column -->
        <th>Status</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="ordersTable"></tbody>
  </table>
</div>

<!-- Add Order Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="orderForm">
        <div class="modal-header">
          <h5 class="modal-title">Add New Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row">
          <div class="col-md-6">
            <h6>Customer Info</h6>
            <input class="form-control mb-2" placeholder="Full Name" id="custName" required>
            <input class="form-control mb-2" placeholder="ID Number" id="custIdNumber" required>
            <input class="form-control mb-2" placeholder="Phone" id="custPhone" required>
            <input class="form-control mb-2" placeholder="Email" id="custEmail">
            <input class="form-control mb-2" type="date" id="orderDate" required>
          </div>
          <div class="col-md-6">
            <h6>Order Items</h6>
            <div id="productList" style="max-height: 250px; overflow-y: auto;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save Order</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "http://127.0.0.1:5000";
  
  // Security check is unchanged
  const role = sessionStorage.getItem("role") || "guest";
  if (role !== "admin") {
    alert("Access denied. Admins only.");
    window.location.href = window.location.href.replace(/[^/]*$/, 'login.html');
  }

  // fetchOrders is unchanged
  async function fetchOrders(params = {}) {
    try {
      const query = new URLSearchParams(params).toString();
      const res = await fetch(`${API_URL}/orders?${query}`);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const orders = await res.json();
      renderOrders(orders);
    } catch (err) {
      console.error("Failed to fetch orders:", err);
      document.getElementById("ordersTable").innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load orders. Is the server running?</td></tr>`;
    }
  }

  function renderOrders(orders) {
    const table = document.getElementById("ordersTable");
    table.innerHTML = "";
    if (orders.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">No orders found.</td></tr>';
        return;
    }
    const statuses = ["Order Received", "Pending", "Shipped", "Delivered", "Cancelled"];
    
    orders.forEach(order => {
      const row = document.createElement("tr");
      const optionsHtml = statuses.map(s => `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`).join('');
      const statusDropdown = `<select class="form-select form-select-sm status-select" onchange="updateStatus(${order.order_id}, this.value)">${optionsHtml}</select>`;
      
      // UPDATED: Display both timestamps elegantly
      const creationTime = order.creation_timestamp ? new Date(order.creation_timestamp).toLocaleString('he-IL') : 'N/A';
      const updateTime = order.last_updated_timestamp ? new Date(order.last_updated_timestamp).toLocaleString('he-IL') : 'N/A';
      
      row.innerHTML = `
        <td>#${order.order_id}</td>
        <td>${order.customer}</td>
        <td>
          <div>Created: <span class="timestamp">${creationTime}</span></div>
          <div>Updated: <span class="timestamp">${updateTime}</span></div>
        </td>
        <td>${statusDropdown}</td>
        <td>$${order.total ? order.total.toFixed(2) : '0.00'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails(${order.order_id})"><i class="bi bi-eye"></i></button>
        </td>
      `;
      table.appendChild(row);
    });
  }

  // UPDATED: Refresh table after status update to show new timestamp
  async function updateStatus(orderId, newStatus) {
    try {
        const res = await fetch(`${API_URL}/orders/${orderId}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        if (!res.ok) {
            alert('Failed to update status.');
        }
        fetchOrders(); // Always refresh to show the new update time
    } catch(err) {
        console.error("Error updating status:", err);
        alert('An error occurred while updating status.');
    }
  }
  
  // The rest of the script is unchanged
  async function loadProducts() {
    const res = await fetch(`${API_URL}/products`);
    const products = await res.json();
    const list = document.getElementById("productList");
    list.innerHTML = "";
    products.forEach(p => {
      const div = document.createElement("div");
      div.className = "input-group mb-2";
      div.innerHTML = `<span class="input-group-text">${p.name}</span><input type="number" min="0" class="form-control" placeholder="Qty" data-product-id="${p.product_id}" data-price="${p.price}">`;
      list.appendChild(div);
    });
  }

  document.getElementById("orderForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const items = [...document.querySelectorAll("#productList input")]
      .map(i => ({ product_id: parseInt(i.dataset.productId), quantity: parseInt(i.value || "0"), price: parseFloat(i.dataset.price) }))
      .filter(i => i.quantity > 0);
    
    if (items.length === 0) { alert("Please select at least one item."); return; }

    const total = items.reduce((sum, i) => sum + (i.quantity * i.price), 0);
    const order = {
      customer: { name: document.getElementById("custName").value, id_number: document.getElementById("custIdNumber").value, phone: document.getElementById("custPhone").value, email: document.getElementById("custEmail").value },
      date: document.getElementById("orderDate").value,
      status: "Order Received",
      total,
      items
    };

    const res = await fetch(`${API_URL}/orders`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(order) });
    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById("orderModal")).hide();
      fetchOrders();
    } else {
      alert("Failed to save order.");
    }
  });

  document.getElementById("searchBtn").addEventListener("click", () => {
    const name = document.getElementById("searchName").value;
    const status = document.getElementById("searchStatus").value;
    const filters = {};
    if (name) filters.name = name;
    if (status) filters.status = status;
    fetchOrders(filters);
  });
  
  document.getElementById("orderModal").addEventListener("show.bs.modal", () => {
    document.getElementById("orderForm").reset();
    document.getElementById("orderDate").valueAsDate = new Date();
    loadProducts();
  });
  
  function viewOrderDetails(orderId) {
      alert("Viewing details for Order ID: " + orderId + "\n(This feature is coming soon!)");
  }

  document.addEventListener('DOMContentLoaded', () => {
      fetchOrders();
  });
</script>

</body>
</html>
